<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Option Chain - {{ ticker }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            text-align: center;
            font-size: 13px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .itm-call {
            background-color: #ccffcc;
        }

        .itm-put {
            background-color: #ffcccc;
        }

        input, select, button {
            font-size: 14px;
            margin: 4px 0;
        }

        h1, h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Option Chain Viewer</h1>

    <form method="post">
        <label for="ticker">Ticker:</label>
        <input type="text" id="ticker" name="ticker" value="{{ ticker }}" required>

        {% if expiries %}
            <label for="expiry">Scadenza:</label>
            <select name="expiry" id="expiry" required>
                <option value="">-- Seleziona una scadenza --</option>
                {% for exp in expiries %}
                    <option value="{{ exp }}" {% if exp == expiry %}selected{% endif %}>{{ exp }}</option>
                {% endfor %}
            </select>
            <button type="submit">Mostra</button>
        {% else %}
            <button type="submit">Cerca Scadenze</button>
        {% endif %}
    </form>

    {% if option_data %}
        <h2>Option Chain - {{ expiry }}</h2>
        <table>
            <tr>
                <th colspan="3">CALL</th>
                <th>Strike</th>
                <th colspan="3">PUT</th>
            </tr>
            <tr>
                <th>Bid</th>
                <th>Ask</th>
                <th>Vol</th>
                <th>Strike</th>
                <th>Bid</th>
                <th>Ask</th>
                <th>Vol</th>
            </tr>

            {% set call_map = {} %}
            {% set put_map = {} %}

            {% for c in option_data.calls %}
                {% set _ = call_map.update({ c.strike: c }) %}
            {% endfor %}
            {% for p in option_data.puts %}
                {% set _ = put_map.update({ p.strike: p }) %}
            {% endfor %}

            {% set all_strikes = call_map.keys() | list + put_map.keys() | list %}
            {% set unique_strikes = all_strikes | unique | sort %}

            {% for strike in unique_strikes %}
                {% set call = call_map.get(strike) %}
                {% set put = put_map.get(strike) %}
                <tr>
                    <td class="{% if call and call.inTheMoney %}itm-call{% endif %}">{{ call.bid if call else '' }}</td>
                    <td class="{% if call and call.inTheMoney %}itm-call{% endif %}">{{ call.ask if call else '' }}</td>
                    <td class="{% if call and call.inTheMoney %}itm-call{% endif %}">{{ call.volume if call else '' }}</td>

                    <td><strong>{{ strike }}</strong></td>

                    <td class="{% if put and put.inTheMoney %}itm-put{% endif %}">{{ put.bid if put else '' }}</td>
                    <td class="{% if put and put.inTheMoney %}itm-put{% endif %}">{{ put.ask if put else '' }}</td>
                    <td class="{% if put and put.inTheMoney %}itm-put{% endif %}">{{ put.volume if put else '' }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}

    <br>
    <a href="/">Torna alla Home</a>
</body>
</html>


